from html2md import Html2Markdown
import html5lib

s = '<div class="rich_media_content " id="js_content">\n                    \n\n                    \n\n                    \n                    \n                    <section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="white-space: normal;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);" data-mpa-powered-by="yiban.io"><p style="color: rgb(0, 0, 0);font-size: 16px;text-align: center;"><span style="color: rgb(127, 127, 127);font-size: 14px;line-height: 1.75em;">点击上方“</span><span style="font-size: 14px;line-height: 1.75em;color: rgb(0, 176, 240);">芋道源码</span><span style="color: rgb(127, 127, 127);font-size: 14px;line-height: 1.75em;">”，选择“<a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486188&amp;idx=3&amp;sn=f160d91ea23e5113e6077c500a2e30c4&amp;chksm=fa49755dcd3efc4bf4f566fbbbf74c191d0b79f2d3222fd211bc52d80b5ef127f52b1158ed71&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2">设为星标</a>”</span></p><p style="font-size: 16px;color: rgb(62, 62, 62);text-align: center;"><span style="color: rgb(127, 127, 127);font-size: 14px;">做积极的人，而不是积极废人！</span></p><section style="color: rgb(0, 0, 0);font-size: medium;line-height: normal;"><section><section><section data-mpa-template-id="692363" data-mpa-color="null" data-mpa-category="fav"><section><section style="margin-top: 10px;margin-bottom: 10px;"><section style="padding-right: 1em;padding-left: 1em;display: inline-block;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: center;"><span style="padding: 0.3em 0.5em;display: inline-block;border-radius: 0.5em;font-size: 13px;color: rgb(255, 255, 255);background-color: rgb(95, 156, 239);"><p>源码精品专栏</p></span>\xa0</section><section style="margin-top: -1em;padding: 20px 10px 10px;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);text-align: center;background-color: rgb(239, 239, 239);"><section><section><section style="text-align: left;"><ul class="list-paddingleft-2" mpa-from-tpl="t" style="list-style-type: circle;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486264&amp;idx=1&amp;sn=475ac3f1ef253a33daacf50477203c80&amp;chksm=fa497489cd3efd9f7298f5da6aad0c443ae15f398436aff57cb2b734d6689e62ab43ae7857ac&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">中文详细注释的开源项目</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484647&amp;idx=1&amp;sn=9eb7e47d06faca20d530c70eec3b8d5c&amp;chksm=fa497b56cd3ef2408f807e66e0903a5d16fbed149ef7374021302901d6e0260ad717d903e8d4&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">RPC 框架 Dubbo 源码解析</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247485054&amp;idx=2&amp;sn=9f3b85f7b8454634da6c5c2ded9b4dba&amp;chksm=fa4979cfcd3ef0d9d2dd92d8d1bd8f1553abc6e2095a5d743e0b2c2afe4955ea2bbbd7a4b79d&amp;token=55862109&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">网络应用框架 Netty 源码解析</a><br></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486256&amp;idx=1&amp;sn=81daccd3fcd2953456c917630636fb26&amp;chksm=fa497481cd3efd97d9239f5eab060e49dea9876a6046eadba0effb878d2fb51f3ba5733e4c0b&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">消息中间件 RocketMQ 源码解析</a><br></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486257&amp;idx=1&amp;sn=4d3c9c675f8833157641a2e0b48e498c&amp;chksm=fa497480cd3efd96fe17975b0b8b141e87fd0a62673e6a30b501460de80b3eb997056f09de08&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">数据库中间件 Sharding-JDBC 和 MyCAT 源码解析</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486258&amp;idx=1&amp;sn=ae5665ae9c3002b53f87cab44948a096&amp;chksm=fa497483cd3efd950514da5a37160e7fd07f0a96f39265cf7ba3721985e5aadbdcbe7aafc34a&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">作业调度中间件 Elastic-Job 源码解析</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486259&amp;idx=1&amp;sn=b023cf3dbf97e5da59db2f4ee632f5a6&amp;chksm=fa497482cd3efd9402d71469f71863f71a6998b27e12ca2e00446b8178d79dcef0721d8e570a&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">分布式事务中间件 TCC-Transaction 源码解析</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486260&amp;idx=1&amp;sn=8f14c0c191d6f8df6eb34202f4ad9708&amp;chksm=fa497485cd3efd93937143a648bc1b530bc7d1f6f8ad4bf2ec112ffe34dee80b474605c22db0&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">Eureka 和 Hystrix 源码解析</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486261&amp;idx=1&amp;sn=bd69f26aadfc826f6313ffbb95e44ee5&amp;chksm=fa497484cd3efd92352d6fb3d05ccbaebca2fafed6f18edbe5be70c99ba088db5c8a7a8080c1&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;">Java 并发源码</a></p></li></ul></section></section></section></section></section></section></section></section></section></section></section><p mpa-paragraph-type="body" style="white-space: normal;letter-spacing: 0.544px;text-align: right;background-color: rgb(255, 255, 255);"><span style="font-size: 10px;color: rgb(136, 136, 136);">来源：http://sina.lt/gfZU</span></p><section class="" style=";"><ul style="" class="list-paddingleft-2"><li><p>前言</p></li><li><p>可靠性</p></li><li><p>代码实现</p></li><ul style="list-style-type: square;" class="list-paddingleft-2"><li><p>组件依赖</p></li><li><p>加锁代码</p></li><li><p>解锁代码</p></li></ul><li><p>总结</p></li></ul><hr style="height: 2px;margin-top: 16px;margin-bottom: 16px;background-color: rgb(231, 231, 231);border-width: 0px;border-style: none;border-color: initial;box-sizing: content-box;"><blockquote style="font-size: 0.9em;overflow: auto;background: rgba(0, 0, 0, 0.05);padding: 10px 10px 10px 1em;color: rgb(153, 153, 153);border-left-width: 1px;border-left-color: rgb(26, 188, 156);margin-left: 2em;"><p style="font-size: 16px;padding-top: 5px;padding-bottom: 5px;color: black;line-height: 26px;">本博客使用第三方开源组件Jedis实现Redis客户端，且只考虑Redis服务端单机部署的场景。</p></blockquote><h1 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.2rem;line-height: 1.225;margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;border-bottom: 1px solid rgb(221, 221, 221);">前言</h1><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">分布式锁一般有三种实现方式：1. 数据库乐观锁；2. 基于Redis的分布式锁；3. 基于ZooKeeper的分布式锁。本篇博客将介绍第二种方式，基于Redis实现分布式锁。虽然网上已经有各种介绍Redis分布式锁实现的博客，然而他们的实现却有着各种各样的问题，为了避免误人子弟，本篇博客将详细介绍如何正确地实现Redis分布式锁。</p><h1 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.2rem;line-height: 1.225;margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;border-bottom: 1px solid rgb(221, 221, 221);">可靠性</h1><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">首先，为了确保分布式锁可用，我们至少要确保锁的实现同时满足以下四个条件：</p><ol style="" class="list-paddingleft-2"><li><p>**互斥性。**在任意时刻，只有一个客户端能持有锁。</p></li><li><p>**不会发生死锁。**即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。</p></li><li><p>**具有容错性。**只要大部分的Redis节点正常运行，客户端就可以加锁和解锁。</p></li><li><p>**解铃还须系铃人。**加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。</p></li></ol><h1 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.2rem;line-height: 1.225;margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;border-bottom: 1px solid rgb(221, 221, 221);">代码实现</h1><h2 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.1rem;line-height: 1.43;margin-top: 20px;margin-bottom: 7px;">组件依赖</h2><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">首先我们要通过Maven引入<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>Jedis</code>开源组件，在<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>pom.xml</code>文件加入下面的代码：</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;"><span class="" style="line-height: 26px;color: #f92672;">&lt;<span class="" style="line-height: 26px;">dependency</span>&gt;</span><br>    <span class="" style="line-height: 26px;color: #f92672;">&lt;<span class="" style="line-height: 26px;">groupId</span>&gt;</span>redis.clients<span class="" style="line-height: 26px;color: #f92672;">&lt;/<span class="" style="line-height: 26px;">groupId</span>&gt;</span><br>    <span class="" style="line-height: 26px;color: #f92672;">&lt;<span class="" style="line-height: 26px;">artifactId</span>&gt;</span>jedis<span class="" style="line-height: 26px;color: #f92672;">&lt;/<span class="" style="line-height: 26px;">artifactId</span>&gt;</span><br>    <span class="" style="line-height: 26px;color: #f92672;">&lt;<span class="" style="line-height: 26px;">version</span>&gt;</span>2.9.0<span class="" style="line-height: 26px;color: #f92672;">&lt;/<span class="" style="line-height: 26px;">version</span>&gt;</span><br><span class="" style="line-height: 26px;color: #f92672;">&lt;/<span class="" style="line-height: 26px;">dependency</span>&gt;</span><br></code></pre><h2 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.1rem;line-height: 1.43;margin-top: 20px;margin-bottom: 7px;">加锁代码</h2><h3 style="color: #34495e;margin-top: 1rem;margin-bottom: 1rem;font-weight: bold;line-height: 1.4;cursor: text;font-size: 1rem;">正确姿势</h3><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">Talk is cheap, show me the code。先展示代码，再带大家慢慢解释为什么这样实现：</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">class</span> <span class="" style="line-height: 26px;font-weight: bold;color: white;">RedisTool</span> </span>{<br><br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">private</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">final</span> String LOCK_SUCCESS = <span class="" style="line-height: 26px;color: #a6e22e;">"OK"</span>;<br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">private</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">final</span> String SET_IF_NOT_EXIST = <span class="" style="line-height: 26px;color: #a6e22e;">"NX"</span>;<br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">private</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">final</span> String SET_WITH_EXPIRE_TIME = <span class="" style="line-height: 26px;color: #a6e22e;">"PX"</span>;<br><br>    <span class="" style="line-height: 26px;color: #75715e;">/**<br>     * 尝试获取分布式锁<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> jedis Redis客户端<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> lockKey 锁<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> requestId 请求标识<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> expireTime 超期时间<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@return</span> 是否获取成功<br>     */</span><br>    <span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">boolean</span> <span class="" style="line-height: 26px;color: #a6e22e;font-weight: bold;">tryGetDistributedLock</span><span class="" style="line-height: 26px;">(Jedis jedis, String lockKey, String requestId, <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">int</span> expireTime)</span> </span>{<br><br>        String result = jedis.set(lockKey, requestId, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, expireTime);<br><br>        <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (LOCK_SUCCESS.equals(result)) {<br>            <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">true</span>;<br>        }<br>        <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">false</span>;<br><br>    }<br><br>}<br></code></pre><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">可以看到，我们加锁就一行代码：<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.set(String key, String value, String nxxx, String expx, int time)</code>，这个set()方法一共有五个形参：</p><ul style="" class="list-paddingleft-2"><li><p>第一个为key，我们使用key来当锁，因为key是唯一的。</p></li><li><p>第二个为value，我们传的是requestId，很多童鞋可能不明白，有key作为锁不就够了吗，为什么还要用到value？原因就是我们在上面讲到可靠性时，分布式锁要满足第四个条件<strong>解铃还须系铃人</strong>，通过给value赋值为requestId，我们就知道这把锁是哪个请求加的了，在解锁的时候就可以有依据。requestId可以使用<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>UUID.randomUUID().toString()</code>方法生成。</p></li><li><p>第三个为nxxx，这个参数我们填的是NX，意思是SET IF NOT EXIST，即当key不存在时，我们进行set操作；若key已经存在，则不做任何操作；</p></li><li><p>第四个为expx，这个参数我们传的是PX，意思是我们要给这个key加一个过期的设置，具体时间由第五个参数决定。</p></li><li><p>第五个为time，与第四个参数相呼应，代表key的过期时间。</p></li></ul><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">总的来说，执行上面的set()方法就只会导致两种结果：1. 当前没有锁（key不存在），那么就进行加锁操作，并对锁设置个有效期，同时value表示加锁的客户端。2. 已有锁存在，不做任何操作。</p><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">心细的童鞋就会发现了，我们的加锁代码满足我们<strong>可靠性</strong>里描述的三个条件。首先，set()加入了NX参数，可以保证如果已有key存在，则函数不会调用成功，也就是只有一个客户端能持有锁，满足互斥性。其次，由于我们对锁设置了过期时间，即使锁的持有者后续发生崩溃而没有解锁，锁也会因为到了过期时间而自动解锁（即key被删除），不会发生死锁。最后，因为我们将value赋值为requestId，代表加锁的客户端请求标识，那么在客户端在解锁的时候就可以进行校验是否是同一个客户端。由于我们只考虑Redis单机部署的场景，所以容错性我们暂不考虑。</p><h3 style="color: #34495e;margin-top: 1rem;margin-bottom: 1rem;font-weight: bold;line-height: 1.4;cursor: text;font-size: 1rem;">错误示例1</h3><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">比较常见的错误示例就是使用<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.setnx()</code>和<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.expire()</code>组合实现加锁，代码如下：</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;"><span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">void</span> <span class="" style="line-height: 26px;color: #a6e22e;font-weight: bold;">wrongGetLock1</span><span class="" style="line-height: 26px;">(Jedis jedis, String lockKey, String requestId, <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">int</span> expireTime)</span> </span>{<br><br>    Long result = jedis.setnx(lockKey, requestId);<br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (result == <span class="" style="line-height: 26px;">1</span>) {<br>        <span class="" style="line-height: 26px;color: #75715e;">// 若在这里程序突然崩溃，则无法设置过期时间，将发生死锁</span><br>        jedis.expire(lockKey, expireTime);<br>    }<br><br>}<br></code></pre><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">setnx()方法作用就是SET IF NOT EXIST，expire()方法就是给锁加一个过期时间。乍一看好像和前面的set()方法结果一样，然而由于这是两条Redis命令，不具有原子性，如果程序在执行完setnx()之后突然崩溃，导致锁没有设置过期时间。那么将会发生死锁。网上之所以有人这样实现，是因为低版本的jedis并不支持多参数的set()方法。</p><h3 style="color: #34495e;margin-top: 1rem;margin-bottom: 1rem;font-weight: bold;line-height: 1.4;cursor: text;font-size: 1rem;">错误示例2</h3><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">这一种错误示例就比较难以发现问题，而且实现也比较复杂。实现思路：使用<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.setnx()</code>命令实现加锁，其中key是锁，value是锁的过期时间。执行过程：1. 通过setnx()方法尝试加锁，如果当前锁不存在，返回加锁成功。2. 如果锁已经存在则获取锁的过期时间，和当前时间比较，如果锁已经过期，则设置新的过期时间，返回加锁成功。代码如下：</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;"><span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">boolean</span> <span class="" style="line-height: 26px;color: #a6e22e;font-weight: bold;">wrongGetLock2</span><span class="" style="line-height: 26px;">(Jedis jedis, String lockKey, <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">int</span> expireTime)</span> </span>{<br><br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">long</span> expires = System.currentTimeMillis() + expireTime;<br>    String expiresStr = String.valueOf(expires);<br><br>    <span class="" style="line-height: 26px;color: #75715e;">// 如果当前锁不存在，返回加锁成功</span><br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (jedis.setnx(lockKey, expiresStr) == <span class="" style="line-height: 26px;">1</span>) {<br>        <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">true</span>;<br>    }<br><br>    <span class="" style="line-height: 26px;color: #75715e;">// 如果锁存在，获取锁的过期时间</span><br>    String currentValueStr = jedis.get(lockKey);<br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (currentValueStr != <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">null</span> &amp;&amp; Long.parseLong(currentValueStr) &lt; System.currentTimeMillis()) {<br>        <span class="" style="line-height: 26px;color: #75715e;">// 锁已过期，获取上一个锁的过期时间，并设置现在锁的过期时间</span><br>        String oldValueStr = jedis.getSet(lockKey, expiresStr);<br>        <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (oldValueStr != <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">null</span> &amp;&amp; oldValueStr.equals(currentValueStr)) {<br>            <span class="" style="line-height: 26px;color: #75715e;">// 考虑多线程并发的情况，只有一个线程的设置值和当前值相同，它才有权利加锁</span><br>            <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">true</span>;<br>        }<br>    }<br><br>    <span class="" style="line-height: 26px;color: #75715e;">// 其他情况，一律返回加锁失败</span><br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">false</span>;<br><br>}<br></code></pre><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">那么这段代码问题在哪里？1. 由于是客户端自己生成过期时间，所以需要强制要求分布式下每个客户端的时间必须同步。 2. 当锁过期的时候，如果多个客户端同时执行<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.getSet()</code>方法，那么虽然最终只有一个客户端可以加锁，但是这个客户端的锁的过期时间可能被其他客户端覆盖。3. 锁不具备拥有者标识，即任何客户端都可以解锁。</p><h2 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.1rem;line-height: 1.43;margin-top: 20px;margin-bottom: 7px;">解锁代码</h2><h3 style="color: #34495e;margin-top: 1rem;margin-bottom: 1rem;font-weight: bold;line-height: 1.4;cursor: text;font-size: 1rem;">正确姿势</h3><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">还是先展示代码，再带大家慢慢解释为什么这样实现：</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">class</span> <span class="" style="line-height: 26px;font-weight: bold;color: white;">RedisTool</span> </span>{<br><br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">private</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">final</span> Long RELEASE_SUCCESS = <span class="" style="line-height: 26px;">1L</span>;<br><br>    <span class="" style="line-height: 26px;color: #75715e;">/**<br>     * 释放分布式锁<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> jedis Redis客户端<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> lockKey 锁<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@param</span> requestId 请求标识<br>     * <span class="" style="line-height: 26px;font-weight: bold;">@return</span> 是否释放成功<br>     */</span><br>    <span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">boolean</span> <span class="" style="line-height: 26px;color: #a6e22e;font-weight: bold;">releaseDistributedLock</span><span class="" style="line-height: 26px;">(Jedis jedis, String lockKey, String requestId)</span> </span>{<br><br>        String script = <span class="" style="line-height: 26px;color: #a6e22e;">"if redis.call(\'get\', KEYS[1]) == ARGV[1] then return redis.call(\'del\', KEYS[1]) else return 0 end"</span>;<br>        Object result = jedis.eval(script, Collections.singletonList(lockKey), Collections.singletonList(requestId));<br><br>        <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (RELEASE_SUCCESS.equals(result)) {<br>            <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">true</span>;<br>        }<br>        <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">return</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">false</span>;<br><br>    }<br><br>}<br></code></pre><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">可以看到，我们解锁只需要两行代码就搞定了！第一行代码，我们写了一个简单的Lua脚本代码，上一次见到这个编程语言还是在《黑客与画家》里，没想到这次居然用上了。第二行代码，我们将Lua代码传到<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.eval()</code>方法里，并使参数KEYS[1]赋值为lockKey，ARGV[1]赋值为requestId。eval()方法是将Lua代码交给Redis服务端执行。</p><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">那么这段Lua代码的功能是什么呢？其实很简单，首先获取锁对应的value值，检查是否与requestId相等，如果相等则删除锁（解锁）。那么为什么要使用Lua语言来实现呢？因为要确保上述操作是原子性的。关于非原子性会带来什么问题，可以阅读【解锁代码-错误示例2】 。那么为什么执行eval()方法可以确保原子性，源于Redis的特性，下面是官网对eval命令的部分解释：</p><figure style="mairgin: 0;margin-top: 10px;margin-bottom: 10px;"><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/eZzl4LXykQz6o94qYzhfAm1CAaunD2QRMU3tVjfRhfJ5IXoEzXOH7kmdOsMtZ6Jv9yF8iaNF9cM7ddJyMn9YBVA/640?wx_fmt=jpeg" data-type="jpeg" class="img_loading" data-ratio="0.5265625" data-w="640" _width="640px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="width: 640px !important; height: 337px !important;" crossorigin="anonymous"><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;">img</figcaption></figure><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">简单来说，就是在eval命令执行Lua代码的时候，Lua代码将被当成一个命令去执行，并且直到eval命令执行完成，Redis才会执行其他命令。</p><h3 style="color: #34495e;margin-top: 1rem;margin-bottom: 1rem;font-weight: bold;line-height: 1.4;cursor: text;font-size: 1rem;">错误示例1</h3><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">最常见的解锁代码就是直接使用<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.del()</code>方法删除锁，这种不先判断锁的拥有者而直接解锁的方式，会导致任何客户端都可以随时进行解锁，即使这把锁不是它的。</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;">public static void wrongReleaseLock1(Jedis jedis, String lockKey) {<br>    jedis.del(lockKey);<br>}<br></code></pre><h3 style="color: #34495e;margin-top: 1rem;margin-bottom: 1rem;font-weight: bold;line-height: 1.4;cursor: text;font-size: 1rem;">错误示例2</h3><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">这种解锁代码乍一看也是没问题，甚至我之前也差点这样实现，与正确姿势差不多，唯一区别的是分成两条命令去执行，代码如下：</p><pre class="" style="overflow-x: auto;"><code class="" style="font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;display: block;overflow-x: auto;padding: 16px;background: #272822;color: #ddd;"><span class="" style="line-height: 26px;"><span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">public</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">static</span> <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">void</span> <span class="" style="line-height: 26px;color: #a6e22e;font-weight: bold;">wrongReleaseLock2</span><span class="" style="line-height: 26px;">(Jedis jedis, String lockKey, String requestId)</span> </span>{<br><br>    <span class="" style="line-height: 26px;color: #75715e;">// 判断加锁与解锁是不是同一个客户端</span><br>    <span class="" style="line-height: 26px;color: #f92672;font-weight: bold;">if</span> (requestId.equals(jedis.get(lockKey))) {<br>        <span class="" style="line-height: 26px;color: #75715e;">// 若在此时，这把锁突然不是这个客户端的，则会误解锁</span><br>        jedis.del(lockKey);<br>    }<br><br>}<br></code></pre><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">如代码注释，问题在于如果调用<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.del()</code>方法的时候，这把锁已经不属于当前客户端的时候会解除他人加的锁。那么是否真的有这种场景？答案是肯定的，比如客户端A加锁，一段时间之后客户端A解锁，在执行<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>jedis.del()</code>之前，锁突然过期了，此时客户端B尝试加锁成功，然后客户端A再执行del()方法，则将客户端B的锁给解除了。</p><h1 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.2rem;line-height: 1.225;margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;border-bottom: 1px solid rgb(221, 221, 221);">总结</h1><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">本文主要介绍了如何使用Java代码正确实现Redis分布式锁，对于加锁和解锁也分别给出了两个比较经典的错误示例。其实想要通过Redis实现分布式锁并不难，只要保证能满足可靠性里的四个条件。互联网虽然给我们带来了方便，只要有问题就可以google，然而网上的答案一定是对的吗？其实不然，所以我们更应该时刻保持着质疑精神，多想多验证。</p><p style="padding-top: 5px;padding-bottom: 5px;line-height: 26px;margin-top: 0.8em;margin-bottom: 0.8em;">如果你的项目中Redis是多机部署的，那么可以尝试使用<code style=\'font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: "Operator Mono", Consolas, Monaco, Menlo, monospace;word-break: break-all;\'>Redisson</code>实现分布式锁，这是Redis官方提供的Java组件，链接在<strong>参考阅读</strong>章节已经给出。</p><h1 style="color: rgb(52, 73, 94);font-weight: bold;cursor: text;font-size: 1.2rem;line-height: 1.225;margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;border-bottom: 1px solid rgb(221, 221, 221);">参考阅读</h1><ul style="" class="list-paddingleft-2"><li><p>Distributed locks with Redis</p></li><li><p>EVAL command</p></li><li><p>Redisson</p></li></ul></section><p mpa-paragraph-type="body" style="white-space: normal;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><br></p><hr style="white-space: normal;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="white-space: normal;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><hr style="border-style: solid;border-right-width: 0px;border-bottom-width: 0px;border-left-width: 0px;border-color: rgba(0, 0, 0, 0.1);transform-origin: 0px 0px 0px;transform: scale(1, 0.5);"><p style="margin-top: 1.7em;margin-bottom: 1.7em;color: rgb(62, 62, 62);font-size: 15px;line-height: inherit;letter-spacing: 2px;word-spacing: 2px;">欢迎加入我的知识星球，一起探讨架构，交流源码。加入方式，<strong><span style="color: rgb(255, 76, 0);">长按下方二维码噢</span></strong>：<br></p></section><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="white-space: normal;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);"><p style="text-align: center;"><img class="img_loading" data-copyright="0" data-cropselx1="0" data-cropselx2="556" data-cropsely1="0" data-cropsely2="370" data-ratio="0.56" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/JdLkEI9sZffVTY1cbQPIhsMGJcNWFwIDn1HomDs3KMQdVdSpmRkicibAFj9FzVtNtQxAtyAhyqmo1N8aibviaU4Qxg/640?wx_fmt=jpeg" data-type="jpeg" data-w="900" style="width: 556px !important; height: 311.36px !important;" _width="556px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="text-align: left;">已在知识星球更新源码解析如下：<br></p><section data-role="outer" label="Powered by 135editor.com" style="font-size: 16px;font-family: 微软雅黑;"><p style="text-align: center;"><img class="img_loading" data-ratio="0.9442815249266863" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfcOlXBvLI0OIxHTfcmz77hIibtCsvTlEOuibdsK5MIU3McxzzJCNzRon1Iv2lSh8qaUlovibV9qlAOXg/640?wx_fmt=png" data-type="png" data-w="1364" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="width: 677px !important; height: 639.279px !important;" crossorigin="anonymous"></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="1.035190615835777" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfcmSgZ4wPnOU7xEGWiaibibnSqiaEU3kLg4te15XaMwvaAZFYyricibfjibyoqPXucUPO3uz1g4kPpoLpXXQ/640?wx_fmt=png" data-type="png" data-w="1364" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="width: 677px !important; height: 700.824px !important;" crossorigin="anonymous"></p><p style="text-align: center;"><img class="img_loading" data-ratio="0.7178002894356006" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfcOlXBvLI0OIxHTfcmz77hImFLNicRZKDNT0EWvZ386AIHwUJNibGicY5hkx9o3Nscp5dzTrADXaX5gg/640?wx_fmt=png" data-type="png" data-w="1382" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="width: 677px !important; height: 485.951px !important;" crossorigin="anonymous"><br></p><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="letter-spacing: 0.544px;"><section data-role="outer" label="Powered by 135editor.com"><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="letter-spacing: 0.544px;"><section data-role="outer" label="Powered by 135editor.com"><p class="" style="text-align: right;"><span style="color: rgb(255, 41, 65);"><strong>如果你喜欢这篇文章，喜欢，转发。</strong></span></p><p class="" style="text-align: right;"><span style="color: rgb(255, 41, 65);"><strong>生活很美好，明天见(｡･ω･｡)ﾉ♡</strong></span></p></section></section></section></section></section></section>\n                </div>'


h = html5lib.HTMLParser(tree=html5lib.getTreeBuilder("dom"))
s = h.parse(s).toxml()

parser = Html2Markdown()
parser.feed(s)
parser.close()
a = parser.output
print(a)
